//- - - - - - - - - - - - -
// OASIS Feedback Tool  //
//- - - - - - - - - - - - -
// By Jon Jenkins, 2010 //
//- - - - - - - - - - - - -
var path = gup("path");
var mkey = gup("mkey");
var mname = "";
var foundpath = false;
if (mkey == "{E435C483-E5E9-4606-B502-27EDD04F1A9A}") { //AHA 2009 as test for AJAX call
    setTimeout(getMeeting(), 10); //Test the AJAX call in one meeting only
}
else {
    doFeedback();
}
function getMeeting() {
    $.ajax({
        type: "POST",
        url: "/WS/OasisWS.asmx/OasisWSGetMeetingInformationJSON",
        data: "{'sessionKey':'', 'meetingKey':'" + mkey + "'}",
        contentType: "application/json; charset=UTF-8",
        dataType: "json",
        success: function (msg) {
            var obj = (typeof msg.d) == 'string' ? eval('(' + msg.d + ')') : msg.d;
            mname = obj.AssociationName;
            doFeedback();
        },
        error: function (msg, gg, uu) {
            mname = "jsonerror";
            doFeedback();
        }
    });
}
function surveypath(path, surveyurl) {
    this.path = path;
    this.surveyurl = surveyurl;
}
function gup(name) {
    name = name.toUpperCase().replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.href.toUpperCase());
    if (results == null)
        return "unknown";
    else
        return results[1];
}
function doFeedback() {
    var cachebust = escape((new Date).valueOf());
    //These paths will be updated once we have all the module-specific surveys created...
    var surveyurl = "http://www.surveymonkey.com/s/DWPTNCT"; //General, backup survey if path doesn't match
    surveylist = new Array(); //Note that querystring request is always caps per JS function
    surveylist[0] = new surveypath("PLAN", "https://www.surveymonkey.com/s/GKV937T"); //Program Planner 7 (collector 2)
    surveylist[1] = new surveypath("VIEWER", "https://www.surveymonkey.com/s/DWCP9CQ"); //Program Planner 6 (collector 1)
    surveylist[2] = new surveypath("SUBMIT", "https://www.surveymonkey.com/s/DWWMDDL"); //Submission
    surveylist[4] = new surveypath("SBMT", "https://www.surveymonkey.com/s/DWWMDDL"); //Submission, Structured
    surveylist[3] = new surveypath("SESSIONS", "https://www.surveymonkey.com/s/DWRNJ99"); //Session Builder
    surveylist[5] = new surveypath("REVIEW", "https://www.surveymonkey.com/s/DW2YS8S"); //Review
    surveylist[6] = new surveypath("OASISMEDIA", "https://www.surveymonkey.com/s/DWDRYT7"); //Digital Poster Submission
    surveylist[7] = new surveypath("EPOSTERVIEWER", "https://www.surveymonkey.com/s/DW7WVM8"); //Digital Poster Viewer
    surveylist[8] = new surveypath("CMED", "https://www.surveymonkey.com/s/DWL9RJT"); //CME/Evaluation
    surveylist[9] = new surveypath("CSUBMIT", "https://www.surveymonkey.com/s/5WJKZX8"); //cSubmit - New Submission UI
    surveylist[10] = new surveypath("CREVIEW", "https://www.surveymonkey.com/r/YBGSXWC"); //cReview - New Review UI

    //Notify TBD
    for (var i = 0; i < surveylist.length; i++) {
        if (surveylist[i].path == path) {
            surveyurl = surveylist[i].surveyurl;
            foundpath = true;
        }
    }

    //Admin - handled with changes in oFeedback.js to capture selected mkey from meeting dropdown
    if (path == "ADMIN") {
        foundpath = true;
    }

    if (foundpath == false) { mkey = path + mkey; } //Allow path to show in SurveyMonkey custom value so we can get unknown paths going to the right survey
    if ((path == "CSUBMIT") || (path == "CREVIEW")) {
        document.write('<div style="font-family: Roboto Condensed, sans-serif!important; font-size:13px"><a target="_blank" href="' + surveyurl + '?c=' + mkey + '&path=' + path + '&mname=' + escape(mname) + '&cb=' + cachebust + '" style="color:#5e7780; text-decoration:none;"><i class="fa fa-lightbulb-o" style="margin-right:2px;" aria-hidden="true"></i>	Feedback</i></a></div>');
    }
    else {
        document.write('<div style="font-family: Roboto Condensed, sans-serif!important; font-size:13px"><a target="_blank" href="' + surveyurl + '?c=' + mkey + '&path=' + path + '&mname=' + escape(mname) + '&cb=' + cachebust + '" style="color:#5e7780; text-decoration:none;"><i class="fa fa-lightbulb-o" style="margin-right:2px;" aria-hidden="true"></i> Feedback</a></div>');
    }

}